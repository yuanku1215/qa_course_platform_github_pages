// assets/js/lessons.js
(function () {
  "use strict";

  const DATA_URL = "data/courses.json";

  function $(id) {
    return document.getElementById(id);
  }

  function el(tag, className, text) {
    const node = document.createElement(tag);
    if (className) node.className = className;
    if (typeof text === "string") node.textContent = text;
    return node;
  }

  function toIdNumber(id) {
    const n = Number(id);
    return Number.isFinite(n) ? n : 0;
  }

  function getTrackParam() {
    const params = new URLSearchParams(location.search);
    const t = (params.get("track") || "").trim().toLowerCase();
    if (t === "modeling" || t === "quantum" || t === "demo") return t;
    return "";
  }

  function inTrack(course, track) {
    if (!track) return true;
    const n = toIdNumber(course && course.id);
    if (track === "modeling") return n >= 100 && n < 200;
    if (track === "quantum") return n >= 200 && n < 300;
    if (track === "demo") return n >= 300 && n < 400;
    return true;
  }

  function safeLink(v) {
    if (typeof v !== "string") return "";
    const s = v.trim();
    return s ? s : "";
  }

  function buildActionLink(label, href) {
    const a = el("a", "btn btnGhost btnTiny", label);
    a.href = href;
    return a;
  }

  function buildCourseRow(course) {
    const row = el("div", "courseRow");

    const info = el("div", "courseInfo");
    const code = el("span", "courseCode", String(course.id || ""));
    const name = el("h3", "courseName", String(course.title || "Untitled"));
    info.appendChild(code);
    info.appendChild(name);

    if (course.description) {
      const desc = el("div", "mutedSmall", String(course.description));
      info.appendChild(desc);
    }

    const actions = el("div", "courseActions");

    const slides = safeLink(course?.downloads?.slides);
    const pdf = safeLink(course?.downloads?.pdf);
    const podcast = safeLink(course?.downloads?.podcast);

    if (slides) actions.appendChild(buildActionLink("Keynote", slides));
    if (pdf) actions.appendChild(buildActionLink("PDF", pdf));
    if (podcast) actions.appendChild(buildActionLink("Podcast (ZH)", podcast));

    const open = el("a", "btn btnPrimary btnTiny", "Open");
    open.href = `course.html?course=${encodeURIComponent(course.id || "")}`;
    actions.appendChild(open);

    row.appendChild(info);
    row.appendChild(actions);

    return row;
  }

  function setHeroTextByTrack(track) {
    const h1 = document.querySelector("h1.heroTitle");
    const p = document.querySelector("p.heroSubtitle");
    if (!h1 || !p) return;

    if (!track) return;

    if (track === "modeling") {
      h1.textContent = "Lessons: Modeling";
      p.textContent = "Foundations of mathematical modeling and algorithm basics.";
      return;
    }
    if (track === "quantum") {
      h1.textContent = "Lessons: Quantum";
      p.textContent = "Quantum annealing concepts and QUBO mapping intuition.";
      return;
    }
    if (track === "demo") {
      h1.textContent = "Lessons: Demos";
      p.textContent = "Practical demos and application templates you can modify.";
      return;
    }
  }

  function render(courses, track) {
    const list = $("lessonList");
    if (!list) return;

    list.innerHTML = "";

    const filtered = courses
      .filter(c => inTrack(c, track))
      .sort((a, b) => toIdNumber(a.id) - toIdNumber(b.id));

    if (!filtered.length) {
      const empty = el("p", "muted", "No courses found for this track.");
      list.appendChild(empty);
      return;
    }

    filtered.forEach(course => {
      list.appendChild(buildCourseRow(course));
    });
  }

  // Background shared implementation
  if (window.Background && typeof window.Background.initBackground === "function") {
    window.Background.initBackground();
  }

  const track = getTrackParam();
  setHeroTextByTrack(track);

  fetch(DATA_URL, { cache: "force-cache" })
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    })
    .then(data => {
      const courses = Array.isArray(data?.courses) ? data.courses : [];
      render(courses, track);
    })
    .catch(() => {
      const list = $("lessonList");
      if (!list) return;
      list.innerHTML = "";
      const msg = el("p", "muted", "Failed to load course data. Please check data/courses.json.");
      list.appendChild(msg);
    });
})();
